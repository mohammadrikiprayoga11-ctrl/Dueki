<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dompetku Pro v10.3</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; padding-bottom: 90px; user-select: none; touch-action: manipulation; }
        input, select, textarea { user-select: text !important; -webkit-user-select: text !important; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1); }
        .nav-active { color: #6366f1; font-weight: bold; transform: scale(1.1); transition: 0.2s; }
        .page { display: none; }
        .page-active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #list, #note-list { max-height: 40vh; overflow-y: auto; }
        .rekap-scroll { display: flex; overflow-x: auto; gap: 12px; padding-bottom: 10px; scrollbar-width: none; }
        .rekap-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

    <div id="main-header" class="bg-indigo-600 pt-8 px-6 pb-6 rounded-b-[2.5rem] text-white shadow-xl sticky top-0 z-40">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-black tracking-tighter uppercase">Dompetku <span class="text-indigo-200">v10.3</span></h1>
            <div class="bg-indigo-800/40 p-1 rounded-full flex text-[10px]">
                <button onclick="switchTab(1)" id="btn-tab-1" class="px-4 py-1.5 rounded-full bg-white text-indigo-600 font-bold shadow-sm">TAB 1</button>
                <button onclick="switchTab(2)" id="btn-tab-2" class="px-4 py-1.5 rounded-full font-bold">TAB 2</button>
            </div>
        </div>
        <div id="header-finance">
            <p class="text-center text-[10px] opacity-80 uppercase tracking-widest mb-1">Saldo Berjalan</p>
            <h1 id="total-balance" class="text-3xl font-black text-center mb-6 text-yellow-300 font-mono">Rp 0</h1>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/10 p-3 rounded-2xl border border-white/10 backdrop-blur-sm text-center text-green-300">
                    <p class="text-[9px] opacity-70 uppercase text-white">Pemasukan</p>
                    <p id="sum-income" class="font-bold">Rp 0</p>
                </div>
                <div class="bg-white/10 p-3 rounded-2xl border border-white/10 backdrop-blur-sm text-center text-red-300">
                    <p class="text-[9px] opacity-70 uppercase text-white">Pengeluaran</p>
                    <p id="sum-expense" class="font-bold">Rp 0</p>
                </div>
            </div>
        </div>
        <div id="header-notes" class="hidden py-4 text-center">
            <h1 class="text-2xl font-black">CATATAN BEBAS üìù</h1>
            <p class="text-xs opacity-70">Tulis rencana atau daftar belanjaanmu</p>
        </div>
    </div>

    <div id="page-home" class="page page-active pt-6 px-5">
        <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 mb-6 space-y-3">
            <div class="flex gap-2 text-[10px]">
                <input id="f-start" onchange="render()" type="date" class="flex-1 p-2 bg-gray-50 rounded-lg outline-none border focus:border-indigo-400">
                <input id="f-end" onchange="render()" type="date" class="flex-1 p-2 bg-gray-50 rounded-lg outline-none border focus:border-indigo-400">
            </div>
            <div class="flex gap-2">
                <input id="f-text" oninput="render()" type="text" placeholder="Cari transaksi..." class="flex-[3] p-2.5 bg-gray-50 rounded-xl text-xs outline-none border">
                <button onclick="exportCSV()" class="flex-1 bg-indigo-50 text-indigo-600 px-3 rounded-xl">üì•</button>
            </div>
        </div>
        <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 mb-6">
            <div class="relative h-44"><canvas id="myChart"></canvas></div>
        </div>
        <div id="rekap-container" class="rekap-scroll mb-6"></div>
        <div id="list" class="space-y-3 pb-10"></div>
    </div>

    <div id="page-add" class="page pt-6 px-5">
        <div class="bg-white p-6 rounded-[2rem] card-shadow border-t-8 border-indigo-600">
            <h2 class="text-xl font-black mb-6">Catat Transaksi</h2>
            <div class="space-y-4">
                <input id="date-input" type="date" class="w-full p-4 bg-gray-50 rounded-2xl border focus:border-indigo-400 outline-none">
                <div class="flex gap-2">
                    <select id="cat-icon" class="p-4 bg-gray-50 rounded-2xl border outline-none">
                        <option value="üí∞">üí∞</option><option value="üçî">üçî</option><option value="üöó">üöó</option>
                        <option value="üè†">üè†</option><option value="‚ö°">‚ö°</option><option value="üõí">üõí</option>
                    </select>
                    <input id="desc" type="text" placeholder="Keterangan..." class="flex-1 p-4 bg-gray-50 rounded-2xl border outline-none">
                </div>
                <input id="amount" type="number" placeholder="Nominal Rp" class="w-full p-4 bg-gray-50 rounded-2xl border font-bold text-xl text-indigo-600">
                <div class="flex items-center gap-3 p-3 bg-yellow-50 rounded-2xl border border-yellow-100">
                    <input type="checkbox" id="important-check" class="w-5 h-5 accent-yellow-500">
                    <label for="important-check" class="text-sm font-bold text-yellow-700">Penting ‚≠ê</label>
                </div>
                <div class="flex gap-3 pt-4">
                    <button onclick="save('income')" class="flex-1 bg-green-500 text-white py-4 rounded-2xl font-bold">MASUK</button>
                    <button onclick="save('expense')" class="flex-1 bg-red-500 text-white py-4 rounded-2xl font-bold">KELUAR</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-notes" class="page pt-6 px-5">
        <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-6">
            <textarea id="note-input" rows="3" placeholder="Tulis catatan baru di sini..." class="w-full p-3 bg-slate-50 rounded-2xl text-sm outline-none border focus:border-indigo-400 mb-3"></textarea>
            <button onclick="saveNote()" id="btn-save-note" class="w-full bg-indigo-600 text-white py-3 rounded-2xl font-bold shadow-lg">SIMPAN CATATAN</button>
        </div>
        <div id="note-list" class="space-y-4 pb-10"></div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-100 p-4 flex justify-around shadow-2xl z-50">
        <button onclick="showPage('home')" id="nav-home" class="flex flex-col items-center nav-active">
            <span class="text-2xl">üè†</span><span class="text-[10px]">Home</span>
        </button>
        <button onclick="showPage('add')" id="nav-add" class="flex flex-col items-center text-gray-400">
            <span class="text-2xl">‚ûï</span><span class="text-[10px]">Catat</span>
        </button>
        <button onclick="showPage('notes')" id="nav-notes" class="flex flex-col items-center text-gray-400">
            <span class="text-2xl">üìù</span><span class="text-[10px]">Notes</span>
        </button>
    </div>

    <script>
        /* LOGIKA APLIKASI (SAMA SEPERTI SEBELUMNYA) */
        let currentTab = 1;
        let data1 = JSON.parse(localStorage.getItem('dompet_v10_1')) || [];
        let data2 = JSON.parse(localStorage.getItem('dompet_v10_2')) || [];
        let notes = JSON.parse(localStorage.getItem('dompet_notes')) || [];
        let editIndex = -1;
        let noteEditIndex = -1;
        let myChart = null;

        function switchTab(t) {
            currentTab = t;
            document.getElementById('btn-tab-1').className = t===1 ? 'px-4 py-1.5 rounded-full bg-white text-indigo-600 font-bold shadow-sm' : 'px-4 py-1.5 rounded-full font-bold';
            document.getElementById('btn-tab-2').className = t===2 ? 'px-4 py-1.5 rounded-full bg-white text-indigo-600 font-bold shadow-sm' : 'px-4 py-1.5 rounded-full font-bold';
            render();
        }

        function getData() { return currentTab === 1 ? data1 : data2; }

        function showPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('page-active'));
            document.getElementById('page-'+p).classList.add('page-active');
            if(p === 'notes') {
                document.getElementById('header-finance').classList.add('hidden');
                document.getElementById('header-notes').classList.remove('hidden');
            } else {
                document.getElementById('header-finance').classList.remove('hidden');
                document.getElementById('header-notes').classList.add('hidden');
            }
            ['home', 'add', 'notes'].forEach(nav => {
                const el = document.getElementById('nav-'+nav);
                el.className = (nav === p) ? 'flex flex-col items-center nav-active' : 'flex flex-col items-center text-gray-400';
            });
            if(p === 'home') render();
            if(p === 'notes') renderNotes();
        }

        function render() {
            const list = document.getElementById('list');
            const rekapContainer = document.getElementById('rekap-container');
            const searchText = document.getElementById('f-text').value.toLowerCase();
            const fStart = document.getElementById('f-start').value;
            const fEnd = document.getElementById('f-end').value;
            let tin = 0, tout = 0;
            let groupMonth = {};
            list.innerHTML = '';
            rekapContainer.innerHTML = '';
            const activeData = getData();
            activeData.sort((a, b) => new Date(b.date) - new Date(a.date));
            activeData.forEach((item, i) => {
                const monthKey = item.date.substring(0, 7);
                if(!groupMonth[monthKey]) groupMonth[monthKey] = { in: 0, out: 0 };
                if(item.type === 'income') groupMonth[monthKey].in += item.val; else groupMonth[monthKey].out += item.val;
                if(item.desc.toLowerCase().includes(searchText) && (!fStart || item.date >= fStart) && (!fEnd || item.date <= fEnd)) {
                    if(item.type === 'income') tin += item.val; else tout += item.val;
                    const tgl = new Date(item.date).toLocaleDateString('id-ID', {day:'2-digit', month:'short'});
                    list.innerHTML += `
                        <div class="flex items-center gap-4 bg-white p-4 rounded-3xl border-l-4 ${item.isImportant ? 'border-yellow-400 bg-yellow-50' : (item.type==='income' ? 'border-green-400' : 'border-red-400')}">
                            <div class="text-2xl">${item.icon || 'üí∞'}</div>
                            <div class="flex-1">
                                <p class="text-[9px] text-gray-400 font-bold uppercase">${tgl}</p>
                                <p class="font-bold text-slate-700 text-sm capitalize">${item.desc}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-sm ${item.type==='income' ? 'text-green-500' : 'text-red-500'}">${item.type==='income'?'+':'-'}${item.val.toLocaleString()}</p>
                                <div class="text-[9px] mt-1 flex gap-2 justify-end">
                                    <button onclick="startEdit(${i})" class="text-indigo-400 font-bold">EDIT</button>
                                    <button onclick="deleteItem(${i})" class="text-red-300 font-bold">HAPUS</button>
                                </div>
                            </div>
                        </div>`;
                }
            });
            Object.keys(groupMonth).sort().reverse().forEach(month => {
                const dateObj = new Date(month + "-01");
                const monthName = dateObj.toLocaleDateString('id-ID', {month:'long'});
                const net = groupMonth[month].in - groupMonth[month].out;
                rekapContainer.innerHTML += `
                    <div class="min-w-[140px] bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-[10px]">
                        <p class="font-black text-slate-400 uppercase mb-1">${monthName}</p>
                        <p class="text-green-500 font-bold">‚ñ≤ ${groupMonth[month].in.toLocaleString()}</p>
                        <p class="text-red-400 font-bold mb-1">‚ñº ${groupMonth[month].out.toLocaleString()}</p>
                        <p class="border-t pt-1 font-black ${net >= 0 ? 'text-indigo-600' : 'text-red-600'}">Rp ${net.toLocaleString()}</p>
                    </div>`;
            });
            document.getElementById('total-balance').innerText = `Rp ${(tin-tout).toLocaleString()}`;
            document.getElementById('sum-income').innerText = `Rp ${tin.toLocaleString()}`;
            document.getElementById('sum-expense').innerText = `Rp ${tout.toLocaleString()}`;
            updateChart(tin, tout);
        }

        function save(type) {
            const desc = document.getElementById('desc').value;
            const val = parseInt(document.getElementById('amount').value);
            const date = document.getElementById('date-input').value;
            const icon = document.getElementById('cat-icon').value;
            const isImportant = document.getElementById('important-check').checked;
            if(!desc || !val || !date) return alert("Lengkapi data!");
            const item = { desc, val, type, date, icon, isImportant };
            const activeData = getData();
            if(editIndex > -1) activeData[editIndex] = item;
            else activeData.unshift(item);
            localStorage.setItem(currentTab===1 ? 'dompet_v10_1' : 'dompet_v10_2', JSON.stringify(activeData));
            resetForm();
            showPage('home');
        }

        function updateChart(tin, tout) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { datasets: [{ data: [tin||1, tout||0], backgroundColor: ['#4ade80', '#f87171'], borderWidth: 0 }] },
                options: { cutout: '85%', plugins: { legend: { display: false } } }
            });
        }

        function deleteItem(i) {
            if(confirm("Hapus transaksi?")) {
                const activeData = getData();
                activeData.splice(i, 1);
                localStorage.setItem(currentTab===1 ? 'dompet_v10_1' : 'dompet_v10_2', JSON.stringify(activeData));
                render();
            }
        }

        function resetForm() {
            editIndex = -1;
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date-input').valueAsDate = new Date();
        }

        function saveNote() {
            const text = document.getElementById('note-input').value;
            if(!text) return alert("Catatan masih kosong!");
            const time = new Date().toLocaleString('id-ID', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
            if(noteEditIndex > -1) {
                notes[noteEditIndex] = { text, time };
                noteEditIndex = -1;
                document.getElementById('btn-save-note').innerText = "SIMPAN CATATAN";
            } else {
                notes.unshift({ text, time });
            }
            localStorage.setItem('dompet_notes', JSON.stringify(notes));
            document.getElementById('note-input').value = '';
            renderNotes();
        }

        function renderNotes() {
            const noteList = document.getElementById('note-list');
            noteList.innerHTML = '';
            notes.forEach((n, i) => {
                noteList.innerHTML += `
                    <div class="bg-white p-4 rounded-3xl border border-slate-100 shadow-sm">
                        <p class="text-[9px] font-bold text-slate-300 mb-2 uppercase tracking-widest">${n.time}</p>
                        <p class="text-sm text-slate-700 leading-relaxed mb-3">${n.text.replace(/\n/g, '<br>')}</p>
                        <div class="flex justify-end gap-3 border-t pt-2">
                            <button onclick="editNote(${i})" class="text-[10px] font-black text-indigo-400">EDIT</button>
                            <button onclick="deleteNote(${i})" class="text-[10px] font-black text-red-300">HAPUS</button>
                        </div>
                    </div>`;
            });
        }

        function editNote(i) {
            noteEditIndex = i;
            document.getElementById('note-input').value = notes[i].text;
            document.getElementById('btn-save-note').innerText = "UPDATE CATATAN";
            window.scrollTo(0,0);
        }

        function deleteNote(i) {
            if(confirm("Hapus catatan?")) {
                notes.splice(i, 1);
                localStorage.setItem('dompet_notes', JSON.stringify(notes));
                renderNotes();
            }
        }

        function exportCSV() {
            let csv = "Tanggal,Keterangan,Tipe,Nominal\n";
            getData().forEach(item => { csv += `${item.date},${item.desc},${item.type},${item.val}\n`; });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laporan-tab${currentTab}.csv`;
            a.click();
        }

        document.getElementById('date-input').valueAsDate = new Date();
        render();

        /* --- PENDAFTARAN SERVICE WORKER (SW.JS) --- */
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('Dompetku SW: Aktif!'))
                    .catch(err => console.log('Dompetku SW: Gagal!', err));
            });
        }

        // Mencegah zoom berlebih di mobile agar terasa seperti aplikasi native
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });
    </script>
</body>
</html>
